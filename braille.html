<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>6-Dot Braille Editor (UEB) - Dual View</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
    }
    
    header {
      background: #16213e;
      padding: 15px 20px;
      border-bottom: 2px solid #4fc3f7;
    }
    
    h1 {
      color: #4fc3f7;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .subtitle {
      color: #888;
      font-size: 0.9em;
    }
    
    .main-container {
      display: grid;
      grid-template-columns: 280px 1fr;
      height: calc(100vh - 70px);
    }
    
    /* Sidebar */
    .sidebar {
      background: #16213e;
      padding: 20px;
      border-right: 1px solid #2d2d44;
      overflow-y: auto;
    }
    
    .section-title {
      font-size: 0.85em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #2d2d44;
    }
    
    .keyboard-layout {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .hand {
      display: grid;
      grid-template-columns: repeat(3, 40px);
      gap: 5px;
    }
    
    .key {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: #2d2d44;
      border: 2px solid #3d3d5c;
      border-radius: 6px;
      font-size: 0.9em;
      transition: all 0.1s;
    }
    
    .key.active {
      background: #4fc3f7;
      border-color: #4fc3f7;
      color: #000;
    }
    
    .key-letter { font-weight: bold; }
    .key-dot { font-size: 0.65em; opacity: 0.6; }
    
    /* Layout selector styles */
    .layout-selector {
      margin-bottom: 20px;
      padding: 10px;
      background: #0f0f23;
      border-radius: 8px;
    }
    
    .layout-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 4px;
    }
    
    .layout-option:hover {
      background: #2d2d44;
    }
    
    .layout-option:last-child {
      margin-bottom: 0;
    }
    
    .layout-option input[type="radio"] {
      margin: 0;
      cursor: pointer;
    }
    
    .layout-option label {
      cursor: pointer;
      font-size: 0.9em;
      flex: 1;
    }
    
    .layout-description {
      font-size: 0.75em;
      color: #888;
      margin-left: 24px;
      margin-bottom: 15px;
    }
    
    /* Current input preview */
    .preview-box {
      background: #0f0f23;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .preview-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }
    
    .preview-label {
      font-size: 0.8em;
      color: #888;
    }
    
    .preview-value {
      font-size: 1.5em;
      min-width: 50px;
      text-align: right;
    }
    
    .braille-display {
      font-family: 'Noto Sans Mono', 'Apple Braille', monospace;
      color: #4fc3f7;
      font-size: 2.5em;
    }
    
    .text-display {
      color: #81c784;
    }
    
    .dots-display {
      color: #ff9800;
      font-size: 1.2em;
    }
    
    /* Mode indicator */
    .mode-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #2d2d44;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 0.9em;
    }
    
    .mode-indicator.active {
      background: #4caf50;
      color: #000;
    }
    
    .mode-indicator .mode-icon {
      font-size: 1.2em;
    }
    
    /* Controls */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    button {
      padding: 10px;
      font-size: 0.9em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    
    button.primary { background: #4fc3f7; color: #000; }
    button.primary:hover { background: #81d4fa; }
    button.secondary { background: #2d2d44; color: #fff; }
    button.secondary:hover { background: #3d3d5c; }
    button.danger { background: #c62828; color: #fff; }
    button.danger:hover { background: #e53935; }
    
    /* Instructions */
    .instructions {
      font-size: 0.85em;
      color: #aaa;
      line-height: 1.6;
    }
    
    .instructions kbd {
      background: #2d2d44;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }
    
    /* Main editor area */
    .editor-area {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow: hidden;
    }
    
    .dual-editors {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      flex: 1;
      min-height: 0;
    }
    
    .editor-panel {
      display: flex;
      flex-direction: column;
      background: #0f0f23;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #2d2d44;
    }
    
    .editor-panel:focus-within {
      border-color: #4fc3f7;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #16213e;
      border-bottom: 1px solid #2d2d44;
    }
    
    .panel-title {
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .panel-title .icon {
      font-size: 1.2em;
    }
    
    .char-count {
      font-size: 0.8em;
      color: #888;
    }
    
    .editor-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      font-size: 1.8em;
      line-height: 1.8;
      word-break: break-all;
      white-space: pre-wrap;
      font-family: 'Noto Sans Mono', 'Apple Braille', monospace;
    }
    
    #braille-editor {
      color: #4fc3f7;
    }
    
    #text-editor {
      color: #81c784;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: #4fc3f7;
      animation: blink 1s infinite;
      vertical-align: middle;
      margin-left: 2px;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    
    /* Status bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      background: #16213e;
      border-radius: 8px;
      font-size: 0.85em;
      color: #888;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }
    
    /* Alphabet reference */
    .alphabet-ref {
      margin-top: 20px;
      font-size: 0.8em;
    }
    
    .alphabet-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 3px;
      margin-top: 10px;
    }
    
    .alpha-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      background: #0f0f23;
      border-radius: 4px;
    }
    
    .alpha-braille {
      font-size: 1.3em;
      color: #4fc3f7;
    }
    
    .alpha-text {
      color: #81c784;
    }
    
    .alpha-dots {
      color: #666;
      font-size: 0.85em;
      margin-left: auto;
    }
    
    .alpha-item.highlight {
      background: #4fc3f7;
      color: #000;
    }
    
    .alpha-item.highlight .alpha-braille,
    .alpha-item.highlight .alpha-text,
    .alpha-item.highlight .alpha-dots {
      color: #000;
    }
    
    #braille-preview {
      position: relative;
    }
    #braille-preview::after {
      content: '';
      display: inline-block;
      width: 2px;
      height: 1em;
      background: #4fc3f7;
      margin-left: 2px;
      animation: blink 1s infinite;
      vertical-align: middle;
    }
    #braille-preview.has-input::after {
      opacity: 1;
    }
    #braille-preview:not(.has-input)::after {
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <span>⠃⠗⠁⠊⠇⠇⠑</span>
      <span>6-Dot Braille Editor</span>
    </h1>
    <div class="subtitle">Unified English Braille (UEB) Grade 1 - Learning Mode</div>
  </header>
  
  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="section-title">Keyboard Layout</div>
      
      <!-- Layout Selector -->
      <div class="layout-selector" id="layout-selector"></div>
      <div class="layout-description" id="layout-description"></div>
      
      <div class="section-title">Input Keys</div>
      
      <!-- Dynamic Keyboard Display -->
      <div class="keyboard-layout" id="keyboard-layout"></div>
      
      <div class="section-title">Current Input</div>
      
      <div class="preview-box">
        <div class="preview-row">
          <span class="preview-label">Braille</span>
          <span class="preview-value braille-display" id="braille-preview">⠀</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">Text</span>
          <span class="preview-value text-display" id="text-preview">-</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">Dots</span>
          <span class="preview-value dots-display" id="dots-preview">-</span>
        </div>
      </div>
      
      <!-- Mode indicators -->
      <div class="section-title">Active Modes</div>
      <div class="mode-indicator" id="number-mode-indicator">
        <span class="mode-icon">⠼</span>
        <span>Number Mode</span>
      </div>
      <div class="mode-indicator" id="capital-mode-indicator" style="display: none;">
        <span class="mode-icon">⠠</span>
        <span>Capital Mode</span>
      </div>
      
      <div class="controls">
        <button class="primary" onclick="confirmChar()">⏎ Confirm (Space)</button>
        <button class="secondary" onclick="deleteLastChar()">⌫ Delete Last</button>
        <button class="secondary" onclick="copyToClipboard('braille')">Copy Braille</button>
        <button class="secondary" onclick="copyToClipboard('text')">Copy Text</button>
        <button class="danger" onclick="clearEditor()">Clear All</button>
      </div>
      
      <div class="section-title">How to Input</div>
      
      <div class="instructions">
        <p>Hold <kbd>F</kbd><kbd>D</kbd><kbd>S</kbd> + <kbd>J</kbd><kbd>K</kbd><kbd>L</kbd> to form dots.</p>
        <p style="margin-top:8px">Press <kbd>Space</kbd> to confirm character.</p>
        <p style="margin-top:8px"><kbd>Backspace</kbd> deletes last char.</p>
        <p style="margin-top:8px"><kbd>Esc</kbd> clears current input.</p>
        <p style="margin-top:8px">⠼ (dots 3456) starts number mode.</p>
      </div>
      
      <div class="alphabet-ref">
        <div class="section-title">Alphabet Reference</div>
        <div class="alphabet-grid" id="alphabet-grid"></div>
      </div>
      
      <div class="alphabet-ref">
        <div class="section-title">Number Reference</div>
        <div class="alphabet-grid" id="number-grid"></div>
      </div>
    </div>
    
    <!-- Main Editor Area -->
    <div class="editor-area">
      <div class="dual-editors">
        <!-- Braille Editor -->
        <div class="editor-panel">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon">⠿</span>
              <span>Braille (点字)</span>
            </div>
            <span class="char-count" id="braille-count">0 chars</span>
          </div>
          <div class="editor-content" id="braille-editor"><span class="cursor"></span></div>
        </div>
        
        <!-- Text Editor -->
        <div class="editor-panel">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon">Aa</span>
              <span>Ink Text (墨字)</span>
            </div>
            <span class="char-count" id="text-count">0 chars</span>
          </div>
          <div class="editor-content" id="text-editor"><span class="cursor"></span></div>
        </div>
      </div>
      
      <div class="status-bar">
        <div class="status-item">
          <span class="status-dot"></span>
          <span id="status-text">Ready</span>
        </div>
        <div class="status-item">
          <span>Mode: UEB Grade 1</span>
        </div>
        <div class="status-item">
          <span>Focus anywhere to type</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== KEYBOARD LAYOUTS CONFIGURATION ====================
    
    // Layout definitions - each layout defines which keys correspond to which dots
    // Left hand: dots 1-3, Right hand: dots 4-6
    const LAYOUTS = {
      perkins: {
        name: 'Perkins Style',
        description: 'Standard QWERTY layout: F/D/S (left) and J/K/L (right)',
        // Left hand keys for dots 1, 2, 3
        leftHand: [
          { key: 'f', dot: 1 },
          { key: 'd', dot: 2 },
          { key: 's', dot: 3 }
        ],
        // Right hand keys for dots 4, 5, 6
        rightHand: [
          { key: 'j', dot: 4 },
          { key: 'k', dot: 5 },
          { key: 'l', dot: 6 }
        ]
      },
      sixkey: {
        name: 'Six Key',
        description: 'BrailleMemo/Annie style: D/W/Q (left) and K/O/P (right)',
        leftHand: [
          { key: 'd', dot: 1 },
          { key: 'w', dot: 2 },
          { key: 'q', dot: 3 }
        ],
        rightHand: [
          { key: 'k', dot: 4 },
          { key: 'o', dot: 5 },
          { key: 'p', dot: 6 }
        ]
      },
      homekeys: {
        name: 'Home Keys',
        description: 'ASDF (left) and JKL; (right) - ergonomic position',
        leftHand: [
          { key: 'a', dot: 1 },
          { key: 's', dot: 2 },
          { key: 'd', dot: 3 }
        ],
        rightHand: [
          { key: 'j', dot: 4 },
          { key: 'k', dot: 5 },
          { key: 'l', dot: 6 }
        ]
      },
      vimstyle: {
        name: 'Vim Style',
        description: 'HJKL navigation style for braille input',
        leftHand: [
          { key: 'h', dot: 1 },
          { key: 'j', dot: 2 },
          { key: 'k', dot: 3 }
        ],
        rightHand: [
          { key: 'b', dot: 4 },
          { key: 'n', dot: 5 },
          { key: 'm', dot: 6 }
        ]
      }
    };
    
    // Default layout to use when page loads
    const DEFAULT_LAYOUT = 'perkins';
    
    // Current active layout
    let currentLayout = DEFAULT_LAYOUT;
    
    // Current KEY_MAP (derived from currentLayout)
    let KEY_MAP = {};
    
    // ==================== CONFIGURATION ====================
    const BRAILLE_START = 0x2800;
    
    // Special braille codes
    const NUMBER_SIGN_CODE = 0x3c;   // dots 3456 = ⠼
    const CAPITAL_SIGN_CODE = 0x20;  // dot 6 = ⠠ (actually dot 6 alone in some systems)
    const LETTER_SIGN_CODE = 0x38;   // dots 56 (not used in basic UEB numbers)
    
    // UEB Grade 1 mapping (braille code -> text)
    const UEB_GRADE1 = {
      // Letters a-z
      0x01: 'a', 0x03: 'b', 0x09: 'c', 0x19: 'd', 0x11: 'e',
      0x0b: 'f', 0x1b: 'g', 0x13: 'h', 0x0a: 'i', 0x1a: 'j',
      0x05: 'k', 0x07: 'l', 0x0d: 'm', 0x1d: 'n', 0x15: 'o',
      0x0f: 'p', 0x1f: 'q', 0x17: 'r', 0x0e: 's', 0x1e: 't',
      0x25: 'u', 0x27: 'v', 0x3a: 'w', 0x2d: 'x', 0x3d: 'y',
      0x35: 'z',
      // Punctuation & symbols (UEB standard)
      0x02: ',',    // dots 2
      0x06: ';',    // dots 23
      0x12: ':',    // dots 25
      0x22: '.',    // dots 256
      0x16: '!',    // dots 235
      0x39: '?',    // dots 1456
      0x04: "'",    // dots 3
      0x26: '"',    // dots 236
      0x24: '-',    // dots 36 (hyphen)
      0x2e: '/',    // dots 346
      // Special signs
      0x3c: '⠼',    // Number sign (dots 3456) - displayed as braille symbol
      0x10: '⠠',    // Capital sign indicator (dot 5) - wait, capital is dot 6
      0x28: '"',    // 開始引用符 dots 46
      0x2c: '(',    // 左括弧 dots 346 (実際は0x2e)
      0x1c: ')',    // 右括弧 dots 345 (実際は...)
      // capital sign in UEB
      0x20: '⠠',    // Capital sign (dot 6)
      0x3c: '#',    // Number sign表示用（本来は制御文字）
    };
    
    // Number mapping (a-j -> 1-0 in number mode)
    const NUMBER_MAP = {
      0x01: '1',  // a -> 1
      0x03: '2',  // b -> 2
      0x09: '3',  // c -> 3
      0x19: '4',  // d -> 4
      0x11: '5',  // e -> 5
      0x0b: '6',  // f -> 6
      0x1b: '7',  // g -> 7
      0x13: '8',  // h -> 8
      0x0a: '9',  // i -> 9
      0x1a: '0',  // j -> 0
    };
    
    // Reverse mapping for reference display
    const TEXT_TO_BRAILLE = {};
    Object.entries(UEB_GRADE1).forEach(([code, text]) => {
      if (text.length === 1 && !'⠠⠼'.includes(text)) {
        TEXT_TO_BRAILLE[text] = parseInt(code);
      }
    });
    
    // Number to braille for reference
    const NUMBER_TO_BRAILLE = {};
    Object.entries(NUMBER_MAP).forEach(([code, num]) => {
      NUMBER_TO_BRAILLE[num] = parseInt(code);
    });
    
    // ==================== STATE ====================
    let activeDots = new Set();
    let brailleContent = '';  // Stores braille characters
    let textContent = '';     // Stores decoded text
    let numberMode = false;   // Number mode active after ⠼
    let capitalMode = 0;      // 0: off, 1: next capital, 2: all caps
    
    // ==================== DOM ELEMENTS ====================
    const braillePreview = document.getElementById('braille-preview');
    const textPreview = document.getElementById('text-preview');
    const dotsPreview = document.getElementById('dots-preview');
    const brailleEditor = document.getElementById('braille-editor');
    const textEditor = document.getElementById('text-editor');
    const brailleCount = document.getElementById('braille-count');
    const textCount = document.getElementById('text-count');
    const alphabetGrid = document.getElementById('alphabet-grid');
    const numberGrid = document.getElementById('number-grid');
    const numberModeIndicator = document.getElementById('number-mode-indicator');
    const statusText = document.getElementById('status-text');
    const layoutSelector = document.getElementById('layout-selector');
    const layoutDescription = document.getElementById('layout-description');
    const keyboardLayout = document.getElementById('keyboard-layout');
    
    // ==================== LAYOUT MANAGEMENT ====================
    
    /**
     * Initialize the layout selector UI
     */
    function initLayoutSelector() {
      // Generate radio buttons for each layout
      layoutSelector.innerHTML = Object.entries(LAYOUTS).map(([key, layout]) => `
        <div class="layout-option">
          <input type="radio" id="layout-${key}" name="layout" value="${key}" ${key === currentLayout ? 'checked' : ''}>
          <label for="layout-${key}">${layout.name}</label>
        </div>
      `).join('');
      
      // Add event listeners for layout change
      document.querySelectorAll('input[name="layout"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          setLayout(e.target.value);
        });
      });
      
      // Update description
      updateLayoutDescription();
    }
    
    /**
     * Update the KEY_MAP based on the selected layout
     * @param {string} layoutKey - The key of the layout to use
     */
    function setLayout(layoutKey) {
      if (!LAYOUTS[layoutKey]) {
        console.error(`Unknown layout: ${layoutKey}`);
        return;
      }
      
      currentLayout = layoutKey;
      const layout = LAYOUTS[layoutKey];
      
      // Build KEY_MAP from layout configuration
      KEY_MAP = {};
      
      // Map left hand keys
      layout.leftHand.forEach(({ key, dot }) => {
        KEY_MAP[key.toLowerCase()] = dot;
        KEY_MAP[key.toUpperCase()] = dot; // Also support uppercase
      });
      
      // Map right hand keys
      layout.rightHand.forEach(({ key, dot }) => {
        KEY_MAP[key.toLowerCase()] = dot;
        KEY_MAP[key.toUpperCase()] = dot; // Also support uppercase
      });
      
      // Update description
      updateLayoutDescription();
      
      // Rebuild keyboard visual
      rebuildKeyboardVisual();
      
      // Reset current input
      resetDots();
      
      // Update instructions
      updateInstructions();
      
      console.log(`Layout changed to: ${layout.name}`);
    }
    
    /**
     * Update the layout description text
     */
    function updateLayoutDescription() {
      const layout = LAYOUTS[currentLayout];
      layoutDescription.textContent = layout.description;
    }
    
    /**
     * Rebuild the keyboard visual display based on current layout
     */
    function rebuildKeyboardVisual() {
      const layout = LAYOUTS[currentLayout];
      
      // Generate left hand keys HTML
      const leftHandHTML = layout.leftHand.map(({ key, dot }) => `
        <div class="key" data-key="${key.toLowerCase()}" data-dot="${dot}">
          <span class="key-letter">${key.toUpperCase()}</span>
          <span class="key-dot">${dot}</span>
        </div>
      `).join('');
      
      // Generate right hand keys HTML
      const rightHandHTML = layout.rightHand.map(({ key, dot }) => `
        <div class="key" data-key="${key.toLowerCase()}" data-dot="${dot}">
          <span class="key-letter">${key.toUpperCase()}</span>
          <span class="key-dot">${dot}</span>
        </div>
      `).join('');
      
      keyboardLayout.innerHTML = `
        <div class="hand">${leftHandHTML}</div>
        <div class="hand">${rightHandHTML}</div>
      `;
      
      // Re-attach click/touch event listeners to new keys
      attachKeyListeners();
    }
    
    /**
     * Attach event listeners to keyboard keys
     */
    function attachKeyListeners() {
      document.querySelectorAll('.key').forEach(keyEl => {
        keyEl.addEventListener('mousedown', (e) => {
          e.preventDefault();
          const dot = parseInt(keyEl.dataset.dot);
          activeDots.add(dot);
          keyEl.classList.add('active');
          updatePreview();
        });
        
        keyEl.addEventListener('mouseup', () => {
          keyEl.classList.remove('active');
        });
        
        keyEl.addEventListener('mouseleave', () => {
          keyEl.classList.remove('active');
        });
      });
    }
    
    /**
     * Update the instructions based on current layout
     */
    function updateInstructions() {
      const layout = LAYOUTS[currentLayout];
      const instructionsEl = document.querySelector('.instructions p:first-child');
      
      if (instructionsEl) {
        const leftKeys = layout.leftHand.map(k => `<kbd>${k.key.toUpperCase()}</kbd>`).join('');
        const rightKeys = layout.rightHand.map(k => `<kbd>${k.key.toUpperCase()}</kbd>`).join('');
        instructionsEl.innerHTML = `Hold ${leftKeys} + ${rightKeys} to form dots.`;
      }
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    function dotsToCode(dots) {
      let code = 0;
      dots.forEach(dot => code |= (1 << (dot - 1)));
      return code;
    }
    
    function codeToBraille(code) {
      return String.fromCharCode(BRAILLE_START + code);
    }
    
    function dotsToBraille(dots) {
      return codeToBraille(dotsToCode(dots));
    }
    
    function codeToText(code) {
      return UEB_GRADE1[code] || '?';
    }
    
    function dotsArray(dots) {
      return Array.from(dots).sort((a, b) => a - b);
    }
    
    // Check if code represents a letter a-j (valid in number mode)
    function isLetterAtoJ(code) {
      return code in NUMBER_MAP;
    }
    
    // Check if code represents a letter (any a-z)
    function isLetter(code) {
      return UEB_GRADE1[code] && UEB_GRADE1[code].length === 1 && 
             UEB_GRADE1[code] >= 'a' && UEB_GRADE1[code] <= 'z';
    }
    
    // ==================== DISPLAY FUNCTIONS ====================
    
    function updatePreview() {
      if (activeDots.size === 0) {
        braillePreview.textContent = '\u2800';
        // Show what the next char would be based on mode
        textPreview.textContent = '-';
        dotsPreview.textContent = '-';
        clearAlphabetHighlight();
        return;
      }
      
      const code = dotsToCode(activeDots);
      const braille = codeToBraille(code);
      
      // Determine text based on current mode
      let text;
      if (numberMode && isLetterAtoJ(code)) {
        text = NUMBER_MAP[code];
      } else {
        text = codeToText(code);
      }
      
      const dots = dotsArray(activeDots).join('-');
      
      braillePreview.textContent = braille;
      textPreview.textContent = text;
      dotsPreview.textContent = dots;
      
      braillePreview.classList.toggle('has-input', activeDots.size > 0);
      
      // Highlight in appropriate reference grid
      if (numberMode && isLetterAtoJ(code)) {
        highlightNumber(code);
      } else {
        highlightAlphabet(code);
      }
    }
    
    function updateEditors() {
      // Update braille display
      brailleEditor.innerHTML = brailleContent + '<span class="cursor"></span>';
      
      // Update text display
      textEditor.innerHTML = textContent + '<span class="cursor"></span>';
      
      // Update counts
      brailleCount.textContent = `${brailleContent.length} chars`;
      textCount.textContent = `${textContent.length} chars`;
      
      // Sync scroll positions
      textEditor.scrollTop = brailleEditor.scrollTop;
      
      // Update mode indicators
      numberModeIndicator.classList.toggle('active', numberMode);
      
      // Update status text
      if (numberMode) {
        statusText.textContent = 'Number Mode Active';
      } else {
        statusText.textContent = 'Ready';
      }
    }
    
    function updateKeyVisual(key, active) {
      const keyEl = document.querySelector(`.key[data-key="${key.toLowerCase()}"]`);
      if (keyEl) keyEl.classList.toggle('active', active);
    }
    
    // ==================== ALPHABET REFERENCE ====================
    
    function buildAlphabetReference() {
      const letters = 'abcdefghijklmnopqrstuvwxyz'.split('');
      
      alphabetGrid.innerHTML = letters.map(letter => {
        const code = TEXT_TO_BRAILLE[letter];
        if (code === undefined) return '';
        
        const braille = codeToBraille(code);
        const dots = [];
        for (let i = 1; i <= 6; i++) {
          if (code & (1 << (i - 1))) dots.push(i);
        }
        
        return `
          <div class="alpha-item" data-code="${code}">
            <span class="alpha-braille">${braille}</span>
            <span class="alpha-text">${letter}</span>
            <span class="alpha-dots">${dots.join('')}</span>
          </div>
        `;
      }).join('');
      
      // Build number reference grid
      numberGrid.innerHTML = '1234567890'.split('').map(num => {
        const code = NUMBER_TO_BRAILLE[num];
        if (code === undefined) return '';
        
        const braille = codeToBraille(code);
        const letter = UEB_GRADE1[code];
        const dots = [];
        for (let i = 1; i <= 6; i++) {
          if (code & (1 << (i - 1))) dots.push(i);
        }
        
        return `
          <div class="alpha-item" data-number-code="${code}">
            <span class="alpha-braille">${braille}</span>
            <span class="alpha-text">${num}</span>
            <span class="alpha-dots">${letter}</span>
          </div>
        `;
      }).join('');
    }
    
    function highlightAlphabet(code) {
      clearAlphabetHighlight();
      const item = document.querySelector(`.alpha-item[data-code="${code}"]`);
      if (item) item.classList.add('highlight');
    }
    
    function highlightNumber(code) {
      clearAlphabetHighlight();
      const item = document.querySelector(`.alpha-item[data-number-code="${code}"]`);
      if (item) item.classList.add('highlight');
    }
    
    function clearAlphabetHighlight() {
      document.querySelectorAll('.alpha-item.highlight').forEach(el => {
        el.classList.remove('highlight');
      });
    }
    
    // ==================== INPUT ACTIONS ====================
    
    function confirmChar() {
      const code = dotsToCode(activeDots);
      const braille = codeToBraille(code);
      
      let text;
      
      // Handle special cases
      if (code === 0) {
        // Space - ends number mode
        text = ' ';
        numberMode = false;
      } 
      else if (code === NUMBER_SIGN_CODE) {
        // Number sign - activate number mode
        numberMode = true;
        text = ''; // Don't display number sign in ink text
      }
      else if (code === CAPITAL_SIGN_CODE) {
        capitalMode = 1; // Next character is capitalized
        text = ''; // Not displayed
      }
      else if (code === 0x30) { // dots 56 = Both caps indicators
        // Continuous caps mode (if implemented)
        capitalMode = 2;
        text = '';
      }
      else if (numberMode && isLetterAtoJ(code)) {
        // Number mode: convert a-j to 1-0
        text = NUMBER_MAP[code];
      }
      else {
        // Normal character
        text = codeToText(code);
        
        // Apply capital conversion
        if (capitalMode === 1 && text.length === 1 && text >= 'a' && text <= 'z') {
          text = text.toUpperCase();
          capitalMode = 0; // Reset
        }
        
        // Check if number mode should end
        if (numberMode && !isLetterAtoJ(code) && !',.'.includes(text)) {
          numberMode = false;
        }
      }
      
      brailleContent += braille;
      textContent += text;
      
      resetDots();
      updateEditors();
      // Update capital mode indicator
      updateCapitalModeIndicator();
    }
    
    function updateCapitalModeIndicator() {
      const indicator = document.getElementById('capital-mode-indicator');
      if (capitalMode > 0) {
        indicator.style.display = 'flex';
        indicator.classList.add('active');
      } else {
        indicator.style.display = 'none';
        indicator.classList.remove('active');
      }
    }
    
    function deleteLastChar() {
      if (brailleContent.length === 0) return;
      
      // Check if we're deleting a number sign
      const lastBraille = brailleContent.slice(-1);
      const lastCode = lastBraille.charCodeAt(0) - BRAILLE_START;
      
      // Remove last character
      brailleContent = brailleContent.slice(0, -1);
      textContent = textContent.slice(0, -1);
      
      // Recalculate number mode by scanning remaining content
      recalculateNumberMode();
      
      updateEditors();
    }
    
    function recalculateNumberMode() {
      // Scan backwards to find if we're in number mode
      numberMode = false;
      
      for (let i = brailleContent.length - 1; i >= 0; i--) {
        const code = brailleContent.charCodeAt(i) - BRAILLE_START;
        
        if (code === NUMBER_SIGN_CODE) {
          numberMode = true;
          return;
        }
        
        // Space breaks number mode
        if (code === 0) {
          numberMode = false;
          return;
        }
      }
    }
    
    function clearEditor() {
      brailleContent = '';
      textContent = '';
      numberMode = false;
      resetDots();
      updateEditors();
    }
    
    function resetDots() {
      activeDots.clear();
      document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
      updatePreview();
    }
    
    async function copyToClipboard(type) {
      const text = type === 'braille' ? brailleContent : textContent;
      
      try {
        await navigator.clipboard.writeText(text);
        
        // Visual feedback
        const btns = document.querySelectorAll('.controls button');
        const btn = type === 'braille' ? btns[2] : btns[3];
        const original = btn.textContent;
        btn.textContent = '✓ Copied!';
        btn.style.background = '#4caf50';
        setTimeout(() => {
          btn.textContent = original;
          btn.style.background = '';
        }, 1500);
      } catch (err) {
        console.error('Copy failed:', err);
      }
    }
    
    // ==================== EVENT HANDLERS ====================
    
    document.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      
      // Braille input keys
      if (key in KEY_MAP) {
        e.preventDefault();
        if (!activeDots.has(KEY_MAP[key])) {
          activeDots.add(KEY_MAP[key]);
          updateKeyVisual(key, true);
          updatePreview();
        }
        return;
      }
      
      // Space = confirm
      if (e.code === 'Space') {
        e.preventDefault();
        confirmChar();
        return;
      }
      
      // Backspace = delete
      if (e.key === 'Backspace') {
        e.preventDefault();
        if (activeDots.size > 0) {
          resetDots();
        } else {
          deleteLastChar();
        }
        return;
      }
      
      // Escape = clear dots
      if (e.key === 'Escape') {
        resetDots();
        return;
      }
      
      // Enter = add newline
      if (e.key === 'Enter') {
        e.preventDefault();
        brailleContent += '\n';
        textContent += '\n';
        numberMode = false; // Newline ends number mode
        updateEditors();
        return;
      }
    });
    
    document.addEventListener('keyup', (e) => {
      const key = e.key.toLowerCase();
      if (key in KEY_MAP) {
        updateKeyVisual(key, false);
      }
    });
    
    // Sync scroll between editors
    brailleEditor.addEventListener('scroll', () => {
      textEditor.scrollTop = brailleEditor.scrollTop;
    });
    
    textEditor.addEventListener('scroll', () => {
      brailleEditor.scrollTop = textEditor.scrollTop;
    });
    
    // ==================== INITIALIZATION ====================
    
    function init() {
      // Initialize layout selector UI
      initLayoutSelector();
      
      // Set default layout and initialize KEY_MAP
      setLayout(DEFAULT_LAYOUT);
      
      // Build alphabet reference grids
      buildAlphabetReference();
      
      // Update displays
      updateEditors();
      updatePreview();
    }
    
    // Run initialization
    init();
  </script>
</body>
</html>